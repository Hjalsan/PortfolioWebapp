name: Build and Lighthouse Audit

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '18'

      - name: Navigate to Next.js app and install dependencies
        run: |
          cd NextJS-Portfolio
          npm install

      - name: Build Next.js app
        run: |
          cd NextJS-Portfolio
          npm run build

  lighthouse:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '18'

      - name: Navigate to Next.js app and install dependencies
        run: |
          cd NextJS-Portfolio
          npm install

      - name: Start Next.js app
        run: |
          cd NextJS-Portfolio
          npm start &
        env:
          PORT: 3000 # Ensure the server listens on this port

      - name: Wait for server to be ready
        run: sleep 15 # Adjust this as needed to ensure the server is ready

      - name: Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: 'http://localhost:3000'
          uploadArtifacts: true
